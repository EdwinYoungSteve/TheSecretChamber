<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>å¼€å¹•æ¸¸æˆ</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: 'å¾®è½¯é›…é»‘', Arial, sans-serif; }
        #container { width: 100vw; height: 100vh; position: relative; }
        .background { position: absolute; width: 100vw; height: 100vh; object-fit: cover; z-index: 0; }
    .center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { padding: 16px 32px; font-size: 1.5em; border: none; border-radius: 8px; background: #0078d7; color: #fff; cursor: pointer; margin: 16px; transition: background 0.2s; }
        .btn:hover { background: #005fa3; }
        .options { display: flex; justify-content: center; gap: 48px; }
        .text { font-size: 2em; color: #fff; text-shadow: 2px 2px 8px #000; margin-bottom: 32px; text-align: center; }
    .game-title { font-size: 4em; line-height: 1.05; display: inline-block; }
        .fade-in { animation: fadeIn .6s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #soundBtn { position: absolute; top: 12px; right: 12px; z-index: 10; background: rgba(0,0,0,.55); color: #fff; border: 1px solid rgba(255,255,255,.4); padding: 8px 14px; border-radius: 20px; font-size: 14px; cursor: pointer; backdrop-filter: blur(4px); transition: background .2s; }
        #soundBtn:hover { background: rgba(0,0,0,.75); }
    .video-progress { position:absolute; right:16px; bottom:16px; z-index:11; width:25vw; max-width:25vw; min-width:120px; height:8px; background:rgba(255,255,255,.25); border-radius:4px; overflow:hidden; backdrop-filter:blur(4px); box-shadow:0 2px 6px rgba(0,0,0,.4); }
    .video-progress .bar { height:100%; width:0%; background:linear-gradient(90deg,#00c6ff,#0078d7); transition:width .15s linear; }
    .skip-btn { position:absolute; left:16px; bottom:12px; z-index:11; background:rgba(0,0,0,.55); color:#fff; border:1px solid rgba(255,255,255,.35); padding:8px 18px; font-size:14px; border-radius:22px; cursor:pointer; backdrop-filter:blur(4px); letter-spacing:1px; transition:background .2s, transform .15s; }
    .skip-btn:hover { background:rgba(0,0,0,.75); }
    .skip-btn:active { transform:scale(.95); }
    #pauseBtn { position:absolute; top:12px; left:12px; z-index:12; background:rgba(0,0,0,.55); color:#fff; border:1px solid rgba(255,255,255,.4); padding:8px 16px; border-radius:20px; font-size:14px; cursor:pointer; backdrop-filter:blur(4px); transition:background .2s; }
    #pauseBtn:hover { background:rgba(0,0,0,.75); }
    .pause-overlay { position:absolute; inset:0; z-index:11; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; pointer-events:auto; }
    .pause-overlay span { font-size:3em; color:#fff; text-shadow:0 2px 8px #000; }
    </style>
</head>
<body>
    <div id="container"></div>
    <button id="pauseBtn" style="display:none">â¸ æš‚åœ</button>
    <button id="soundBtn" style="display:none">ğŸ”Š å£°éŸ³å·²å¼€å¯ï¼ˆç‚¹å‡»å…³é—­ï¼‰</button>
    <script>
        const container = document.getElementById('container');
        const soundBtn = document.getElementById('soundBtn');
        let choices = [];
        let audioUnlocked = true; // ç”¨æˆ·æœŸæœ›æ˜¯å¦æœ‰å£°éŸ³
        let autoplayBlocked = false; // æµè§ˆå™¨æ˜¯å¦é˜»æ­¢å¸¦å£°éŸ³è‡ªåŠ¨æ’­æ”¾
    let paused = false; // æ˜¯å¦å¤„äºæš‚åœ
    let pendingCallback = null; // æš‚åœæ—¶å­˜å‚¨çš„ä¸‹ä¸€ä¸ªæ­¥éª¤å›è°ƒ
    let currentVideo = null; // å½“å‰ video å¼•ç”¨

        const preloadList = [ 'background1.jpg','background2.jpg','background3.jpg','background4.jpg', 'video1.mp4','video2.mp4','video3.mp4','video4.mp4','video5.mp4','video6.mp4','video7.mp4','video8.mp4' ];

        function preloadAssets(list) {
            list.forEach(src => {
                if (/\.(jpe?g|png)$/i.test(src)) { const img = new Image(); img.src = src; }
                else if (/\.mp4$/i.test(src)) { const v = document.createElement('video'); v.src = src; v.preload = 'auto'; v.muted = true; }
            });
        }

        function playVideo(src, callback) {
            container.innerHTML = `<video class='background fade-in' src='${src}' autoplay playsinline></video><div class='video-progress'><div class='bar'></div></div><button class='skip-btn'>è·³è¿‡åŠ¨ç”»</button>`;
            const video = container.querySelector('video');
            const progressWrap = container.querySelector('.video-progress');
            const progressBar = progressWrap.querySelector('.bar');
            const skipBtn = container.querySelector('.skip-btn');
            currentVideo = video;
            video.muted = !audioUnlocked || autoplayBlocked;
            if (!video.muted) video.volume = 1;
            const p = video.play();
            if (p && p.catch) {
                p.catch(() => {
                    if (audioUnlocked && !autoplayBlocked) {
                        autoplayBlocked = true;
                        video.muted = true;
                        const retry = video.play(); if (retry && retry.catch) retry.catch(()=>{});
                        updateSoundBtn();
                    }
                });
            }
            const endHandler = () => { 
                video.onended = null; 
                if (progressWrap) progressWrap.remove(); 
                if (skipBtn) skipBtn.disabled = true; 
                if (paused) { // è‹¥æš‚åœåˆ™æŒ‚èµ·å›è°ƒ
                    pendingCallback = callback; 
                } else {
                    callback && callback(); 
                }
            };
            video.onended = endHandler;
            function updateProgress(){
                if (!video.duration || isNaN(video.duration)) return;
                const ratio = Math.min(1, Math.max(0, video.currentTime / video.duration));
                if (progressBar) progressBar.style.width = (ratio * 100).toFixed(2) + '%';
            }
            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('loadedmetadata', updateProgress);
            video.addEventListener('progress', updateProgress);
            if (skipBtn) {
                skipBtn.onclick = () => {
                    if (video.readyState > 0) {
                        try { video.currentTime = video.duration; } catch(e) {}
                    }
                    endHandler();
                };
            }
            if (paused) { // è‹¥åˆšå¥½å¤„äºæš‚åœçŠ¶æ€ï¼Œç«‹åˆ»æš‚åœè§†é¢‘
                try { video.pause(); } catch(e) {}
            }
        }

        function showBackground(src, contentHtml = '') { container.innerHTML = `<img class='background fade-in' src='${src}' />${contentHtml}`; }

        document.addEventListener('keydown', e => {
            const options = container.querySelector('.options'); if (!options) return;
            if (e.key === 'ArrowLeft') { const first = options.querySelector('.btn'); first && first.click(); }
            else if (e.key === 'ArrowRight') { const btns = options.querySelectorAll('.btn'); if (btns.length) btns[btns.length - 1].click(); }
        });

        preloadAssets(preloadList);
        playVideo('opening.mp4', () => {
            showBackground('background1.jpg', `
                <div class='center fade-in'>
                    <div class='text'>
                        <span>æ¬¢è¿æ¥åˆ°</span><br>
                        <span class='game-title'>å¼€å¹•æ¸¸æˆ</span>
                    </div>
                    <button class='btn' onclick='startGame()'>å¼€å§‹æ¸¸æˆ</button>
                </div>
            `);
        });

        function updateSoundBtn() {
            if (audioUnlocked && !autoplayBlocked) soundBtn.textContent = 'ğŸ”Š å£°éŸ³å·²å¼€å¯ï¼ˆç‚¹å‡»å…³é—­ï¼‰';
            else if (audioUnlocked && autoplayBlocked) soundBtn.textContent = 'ğŸ”‡ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼ˆç‚¹å‡»å¼€å¯ï¼‰';
            else soundBtn.textContent = 'ğŸ”‡ å£°éŸ³å·²å…³é—­ï¼ˆç‚¹å‡»å¼€å¯ï¼‰';
        }
        function toggleSound() {
            const v = container.querySelector('video');
            if (audioUnlocked && !autoplayBlocked) {
                audioUnlocked = false; if (v) v.muted = true;
            } else {
                audioUnlocked = true; autoplayBlocked = false; if (v) { v.muted = false; v.volume = 1; const r = v.play(); if (r && r.catch) r.catch(()=>{}); }
            }
            updateSoundBtn();
        }
        soundBtn.style.display = 'block';
        soundBtn.onclick = toggleSound; updateSoundBtn();

        // æš‚åœ/æ¢å¤é€»è¾‘
        const pauseBtn = document.getElementById('pauseBtn');
        pauseBtn.style.display = 'block';
        pauseBtn.onclick = () => {
            if (!paused) {
                paused = true;
                pauseBtn.textContent = 'â–¶ ç»§ç»­';
                // æš‚åœå½“å‰è§†é¢‘
                if (currentVideo) { try { currentVideo.pause(); } catch(e) {} }
                // æ·»åŠ é®ç½©
                if (!document.querySelector('.pause-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'pause-overlay';
                    overlay.innerHTML = '<span>å·²æš‚åœ</span>';
                    container.appendChild(overlay);
                }
            } else {
                paused = false;
                pauseBtn.textContent = 'â¸ æš‚åœ';
                // ç§»é™¤é®ç½©
                const ov = document.querySelector('.pause-overlay');
                if (ov) ov.remove();
                // æ¢å¤è§†é¢‘
                if (currentVideo && currentVideo.paused && !currentVideo.ended) {
                    const r = currentVideo.play(); if (r && r.catch) r.catch(()=>{});
                }
                // è‹¥ä¹‹å‰æŒ‚èµ·äº†å›è°ƒä¸”è§†é¢‘å·²ç»ç»“æŸ
                if (pendingCallback) {
                    const cb = pendingCallback; pendingCallback = null; cb();
                }
            }
        };

        window.startGame = function() {
            playVideo('video1.mp4', () => {
                playVideo('video2.mp4', () => {
                    showBackground('background2.jpg', `
                        <div class='center fade-in'>
                            <div class='text'>è¯·é€‰æ‹©ä½ çš„é“è·¯</div>
                            <div class='options'>
                                <button class='btn' onclick='chooseRoad(1)'>road1</button>
                                <button class='btn' onclick='chooseRoad(2)'>road2</button>
                                <button class='btn' onclick='chooseRoad(3)'>road3</button>
                            </div>
                        </div>
                    `);
                });
            });
        }

        window.chooseRoad = function(road) {
            playVideo('video3.mp4', () => {
                playVideo('video4.mp4', () => {
                    playVideo('video5.mp4', () => {
                        playVideo('video6.mp4', () => {
                            showBackground('background3.jpg', `
                                <div class='center fade-in'>
                                    <div class='text'>æ˜¯</div>
                                    <div class='options'>
                                        <button class='btn' onclick='chooseSide(0)'>å·¦</button>
                                        <button class='btn' onclick='chooseSide(1)'>å³</button>
                                    </div>
                                </div>
                            `);
                        });
                    });
                });
            });
        }

        window.chooseSide = function(side) {
            choices.push(side);
            if (choices.length === 1) {
                showBackground('background4.jpg', `
                    <div class='center fade-in'>
                        <div class='options'>
                            <button class='btn' onclick='chooseSide(0)'>å·¦</button>
                            <button class='btn' onclick='chooseSide(1)'>å³</button>
                        </div>
                    </div>
                `);
            } else if (choices.length === 2) {
                if (choices[0] === choices[1]) playVideo('video8.mp4');
                else playVideo('video7.mp4');
            }
        }
    </script>
</body>
</html>
